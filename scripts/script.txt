#!/usr/bin/env python3
"""
EC2 Health Check Script
Author: Charles Bucher
Purpose: Quick health check for EC2 instances - checks status, CPU, and connectivity
Usage: python ec2_health_check.py --instance-id i-1234567890abcdef0
"""

import boto3
import argparse
from datetime import datetime, timedelta

def check_instance_health(instance_id, region='us-east-1'):
    """
    Performs basic health checks on an EC2 instance.
    Returns a dict with health status and metrics.
    """
    ec2 = boto3.client('ec2', region_name=region)
    cloudwatch = boto3.client('cloudwatch', region_name=region)
    
    print(f"\n{'='*60}")
    print(f"EC2 Health Check Report")
    print(f"Instance ID: {instance_id}")
    print(f"Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"{'='*60}\n")
    
    try:
        # Get instance details
        response = ec2.describe_instances(InstanceIds=[instance_id])
        instance = response['Reservations'][0]['Instances'][0]
        
        # Basic instance info
        state = instance['State']['Name']
        instance_type = instance['InstanceType']
        
        print(f"[✓] Instance State: {state.upper()}")
        print(f"[✓] Instance Type: {instance_type}")
        
        if state != 'running':
            print(f"\n[!] WARNING: Instance is {state}, not running!")
            return
        
        # Check status checks
        status_response = ec2.describe_instance_status(InstanceIds=[instance_id])
        if status_response['InstanceStatuses']:
            status = status_response['InstanceStatuses'][0]
            system_status = status['SystemStatus']['Status']
            instance_status = status['InstanceStatus']['Status']
            
            print(f"[✓] System Status: {system_status}")
            print(f"[✓] Instance Status: {instance_status}")
            
            if system_status != 'ok' or instance_status != 'ok':
                print("\n[!] WARNING: Status checks failing!")
        
        # Get recent CPU utilization (last 15 minutes)
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(minutes=15)
        
        cpu_response = cloudwatch.get_metric_statistics(
            Namespace='AWS/EC2',
            MetricName='CPUUtilization',
            Dimensions=[{'Name': 'InstanceId', 'Value': instance_id}],
            StartTime=start_time,
            EndTime=end_time,
            Period=300,  # 5 minutes
            Statistics=['Average', 'Maximum']
        )
        
        if cpu_response['Datapoints']:
            cpu_data = sorted(cpu_response['Datapoints'], key=lambda x: x['Timestamp'])
            latest = cpu_data[-1]
            avg_cpu = latest['Average']
            max_cpu = latest['Maximum']
            
            print(f"\n--- CPU Metrics (Last 15 min) ---")
            print(f"Average CPU: {avg_cpu:.2f}%")
            print(f"Maximum CPU: {max_cpu:.2f}%")
            
            # Simple threshold check
            if avg_cpu > 80:
                print("[!] WARNING: High CPU usage detected!")
            elif avg_cpu < 5:
                print("[?] NOTE: Very low CPU usage - instance may be idle")
            else:
                print("[✓] CPU usage looks normal")
        else:
            print("\n[?] No CPU metrics available yet")
        
        # Check security group
        if 'SecurityGroups' in instance:
            sg_count = len(instance['SecurityGroups'])
            print(f"\n--- Security ---")
            print(f"Security Groups: {sg_count}")
            for sg in instance['SecurityGroups']:
                print(f"  - {sg['GroupName']} ({sg['GroupId']})")
        
        # Check if public IP exists
        if 'PublicIpAddress' in instance:
            print(f"\n[✓] Public IP: {instance['PublicIpAddress']}")
        else:
            print(f"\n[?] No public IP assigned")
        
        print(f"\n{'='*60}")
        print("Health check complete!")
        print(f"{'='*60}\n")
        
    except Exception as e:
        print(f"\n[✗] ERROR: {str(e)}")
        print("Common issues:")
        print("  - Check AWS credentials are configured")
        print("  - Verify instance ID is correct")
        print("  - Ensure you have CloudWatch:GetMetricStatistics permission")

def main():
    parser = argparse.ArgumentParser(
        description='Quick health check for EC2 instances'
    )
    parser.add_argument(
        '--instance-id',
        required=True,
        help='EC2 instance ID (e.g., i-1234567890abcdef0)'
    )
    parser.add_argument(
        '--region',
        default='us-east-1',
        help='AWS region (default: us-east-1)'
    )
    
    args = parser.parse_args()
    check_instance_health(args.instance_id, args.region)

if __name__ == '__main__':
    main()